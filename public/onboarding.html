<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Your BookIt Technologies - Onboarding</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .step-active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .step-completed {
            background-color: #10b981;
            color: white;
        }
        .step-pending {
            background-color: #e5e7eb;
            color: #6b7280;
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto py-8 px-4">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Welcome to BookIt! üéâ</h1>
            <p class="text-gray-600">Let's set up your AI phone system in just a few minutes</p>
        </div>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-gray-500">Setup Progress</span>
                <span id="progress-text" class="text-sm text-gray-500">Step 1 of 5</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 20%"></div>
            </div>
        </div>

        <!-- Step Navigation -->
        <div class="flex justify-center mb-8">
            <div class="flex items-center space-x-4">
                <div id="step-1" class="step-active flex items-center justify-center w-8 h-8 rounded-full text-sm font-semibold">1</div>
                <div class="w-12 h-1 bg-gray-300"></div>
                <div id="step-2" class="step-pending flex items-center justify-center w-8 h-8 rounded-full text-sm font-semibold">2</div>
                <div class="w-12 h-1 bg-gray-300"></div>
                <div id="step-3" class="step-pending flex items-center justify-center w-8 h-8 rounded-full text-sm font-semibold">3</div>
                <div class="w-12 h-1 bg-gray-300"></div>
                <div id="step-4" class="step-pending flex items-center justify-center w-8 h-8 rounded-full text-sm font-semibold">4</div>
                <div class="w-12 h-1 bg-gray-300"></div>
                <div id="step-5" class="step-pending flex items-center justify-center w-8 h-8 rounded-full text-sm font-semibold">5</div>
            </div>
        </div>

        <!-- Onboarding Steps -->
        <div class="bg-white rounded-lg shadow-sm p-8">
            
            <!-- Step 1: Business Hours -->
            <div id="step-content-1" class="step-content">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">üïê</div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">When are you available?</h2>
                    <p class="text-gray-600">Set your business hours so the AI knows when to offer appointments</p>
                </div>

                <div class="space-y-4 max-w-2xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-7 gap-4">
                        <div class="font-medium text-gray-700 text-center md:text-left">Day</div>
                        <div class="font-medium text-gray-700 text-center">Enabled</div>
                        <div class="font-medium text-gray-700 text-center">Start Time</div>
                        <div class="font-medium text-gray-700 text-center">End Time</div>
                        <div class="font-medium text-gray-700 text-center">Lunch Start</div>
                        <div class="font-medium text-gray-700 text-center">Lunch End</div>
                        <div class="font-medium text-gray-700 text-center">Emergency</div>
                    </div>

                    <div id="business-hours-container">
                        <!-- Days will be populated by JavaScript -->
                    </div>
                </div>

                <div class="flex justify-center mt-8">
                    <button onclick="nextStep()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                        Continue to Services ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 2: Service Configuration -->
            <div id="step-content-2" class="step-content hidden">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">üîß</div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Configure Your Services</h2>
                    <p class="text-gray-600">Review and customize your service types and pricing</p>
                </div>

                <div id="services-container" class="space-y-4 max-w-3xl mx-auto">
                    <!-- Services will be populated by JavaScript -->
                </div>

                <div class="flex justify-center mt-8 space-x-4">
                    <button onclick="previousStep()" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 font-semibold">
                        ‚Üê Back
                    </button>
                    <button onclick="nextStep()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                        Continue to AI Setup ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 3: AI Personality -->
            <div id="step-content-3" class="step-content hidden">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">ü§ñ</div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Customize Your AI Assistant</h2>
                    <p class="text-gray-600">Choose how your AI assistant should talk to customers</p>
                </div>

                <div class="max-w-2xl mx-auto space-y-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">AI Personality</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="personality-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-500" data-personality="professional">
                                <div class="text-center">
                                    <div class="text-2xl mb-2">üëî</div>
                                    <h3 class="font-semibold text-gray-900">Professional</h3>
                                    <p class="text-sm text-gray-600">Formal, efficient, business-focused</p>
                                </div>
                            </div>
                            <div class="personality-option border-2 border-blue-500 bg-blue-50 rounded-lg p-4 cursor-pointer" data-personality="friendly">
                                <div class="text-center">
                                    <div class="text-2xl mb-2">üòä</div>
                                    <h3 class="font-semibold text-gray-900">Friendly</h3>
                                    <p class="text-sm text-gray-600">Warm, approachable, conversational</p>
                                </div>
                            </div>
                            <div class="personality-option border-2 border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-500" data-personality="urgent">
                                <div class="text-center">
                                    <div class="text-2xl mb-2">‚ö°</div>
                                    <h3 class="font-semibold text-gray-900">Urgent</h3>
                                    <p class="text-sm text-gray-600">Quick, direct, emergency-focused</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Description</label>
                        <textarea id="business-description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Tell us about your business so the AI can better help customers...">Expert plumbing services for residential and commercial customers. We handle everything from emergency repairs to new installations.</textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Emergency Message</label>
                        <textarea id="emergency-message" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="What should the AI say for emergency calls?">We understand this is an emergency. Let me get you scheduled for immediate service. Our technician can be there within the hour.</textarea>
                    </div>

                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-gray-900 mb-2">Preview: How Your AI Will Sound</h4>
                        <div id="ai-preview" class="text-gray-700 italic">
                            "Hello! Thanks for calling. I'm Sarah, your AI assistant. I can help you schedule your plumbing service right away. What kind of issue are you having today?"
                        </div>
                    </div>
                </div>

                <div class="flex justify-center mt-8 space-x-4">
                    <button onclick="previousStep()" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 font-semibold">
                        ‚Üê Back
                    </button>
                    <button onclick="nextStep()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                        Continue to Phone Setup ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 4: Phone Number Selection -->
            <div id="step-content-4" class="step-content hidden">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">üìû</div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Choose Your AI Phone Number</h2>
                    <p class="text-gray-600">Select a local phone number for your business</p>
                </div>

                <div class="max-w-4xl mx-auto space-y-6">
                    <!-- Area Code Selection -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <h3 class="font-semibold text-blue-900 mb-4">üìç Select Your Area Code</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <button onclick="searchByAreaCode('201')" class="area-code-btn bg-white border border-blue-300 hover:bg-blue-100 text-blue-800 px-4 py-2 rounded-lg text-center font-medium">
                                201<br><span class="text-xs text-blue-600">New Jersey</span>
                            </button>
                            <button onclick="searchByAreaCode('212')" class="area-code-btn bg-white border border-blue-300 hover:bg-blue-100 text-blue-800 px-4 py-2 rounded-lg text-center font-medium">
                                212<br><span class="text-xs text-blue-600">New York City</span>
                            </button>
                            <button onclick="searchByAreaCode('305')" class="area-code-btn bg-white border border-blue-300 hover:bg-blue-100 text-blue-800 px-4 py-2 rounded-lg text-center font-medium">
                                305<br><span class="text-xs text-blue-600">Miami, FL</span>
                            </button>
                            <button onclick="searchByAreaCode('312')" class="area-code-btn bg-white border border-blue-300 hover:bg-blue-100 text-blue-800 px-4 py-2 rounded-lg text-center font-medium">
                                312<br><span class="text-xs text-blue-600">Chicago, IL</span>
                            </button>
                            <button onclick="searchByAreaCode('404')" class="area-code-btn bg-white border border-blue-300 hover:bg-blue-100 text-blue-800 px-4 py-2 rounded-lg text-center font-medium">
                                404<br><span class="text-xs text-blue-600">Atlanta, GA</span>
                            </button>
                            <button onclick="searchByAreaCode('415')" class="area-code-btn bg-white border border-blue-300 hover:bg-blue-100 text-blue-800 px-4 py-2 rounded-lg text-center font-medium">
                                415<br><span class="text-xs text-blue-600">San Francisco</span>
                            </button>
                            <button onclick="searchByAreaCode('512')" class="area-code-btn bg-white border border-blue-300 hover:bg-blue-100 text-blue-800 px-4 py-2 rounded-lg text-center font-medium">
                                512<br><span class="text-xs text-blue-600">Austin, TX</span>
                            </button>
                            <button onclick="searchByAreaCode('713')" class="area-code-btn bg-white border border-blue-300 hover:bg-blue-100 text-blue-800 px-4 py-2 rounded-lg text-center font-medium">
                                713<br><span class="text-xs text-blue-600">Houston, TX</span>
                            </button>
                        </div>
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-blue-900 mb-2">Or enter a custom area code:</label>
                            <div class="flex gap-2">
                                <input type="text" id="custom-area-code" placeholder="e.g. 555" maxlength="3" 
                                       class="w-24 px-3 py-2 border border-blue-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <button onclick="searchCustomAreaCode()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                    Search
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="loading-numbers" class="hidden text-center py-8">
                        <div class="text-4xl mb-4">‚è≥</div>
                        <p class="text-gray-600">Searching for available numbers...</p>
                    </div>

                    <!-- Available Numbers -->
                    <div id="available-numbers-section" class="hidden">
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="font-semibold text-gray-900">Available Phone Numbers</h3>
                                <span id="selected-area-code-display" class="text-sm text-gray-600"></span>
                            </div>
                            <div id="available-numbers-list" class="space-y-3">
                                <!-- Numbers will be populated here -->
                            </div>
                            <div class="mt-4 text-center">
                                <button onclick="searchMoreNumbers()" class="text-blue-600 hover:text-blue-800 text-sm">
                                    Load More Numbers
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Number Preview -->
                    <div id="selected-number-preview" class="hidden">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <div class="text-center">
                                <div class="text-green-600 mb-2">‚úÖ Selected Phone Number</div>
                                <div id="selected-phone-display" class="text-2xl font-bold text-gray-900 mb-2"></div>
                                <div class="text-sm text-gray-600">This number will be activated for your business</div>
                            </div>
                            
                            <div class="mt-6 space-y-4">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <h4 class="font-semibold text-blue-900 mb-2">üìã Next Steps:</h4>
                                    <ul class="text-sm text-blue-800 space-y-1">
                                        <li>‚Ä¢ Add this number to your website</li>
                                        <li>‚Ä¢ Update your Google Business listing</li>
                                        <li>‚Ä¢ Print on business cards and marketing</li>
                                        <li>‚Ä¢ Set up call forwarding (optional)</li>
                                    </ul>
                                </div>

                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <h4 class="font-semibold text-yellow-900 mb-2">üß™ Test After Setup:</h4>
                                    <p class="text-sm text-yellow-800">Once activated, call your number and say "I need a plumber for my kitchen sink" to test the AI!</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- No Selection Warning -->
                    <div id="no-selection-warning" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                        <p class="text-yellow-800">Please select a phone number to continue</p>
                    </div>
                </div>

                <div class="flex justify-center mt-8 space-x-4">
                    <button onclick="previousStep()" class="bg-gray-200 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-300 font-semibold">
                        ‚Üê Back
                    </button>
                    <button id="continue-with-number" onclick="continueWithSelectedNumber()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold" disabled>
                        Continue to Payment ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 5: Payment & Launch -->
            <div id="step-content-5" class="step-content hidden">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">üöÄ</div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">You're All Set!</h2>
                    <p class="text-gray-600">Your AI phone system is ready. Start your free trial!</p>
                </div>

                <div class="max-w-2xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                            <h3 class="font-semibold text-green-900 mb-3">‚úÖ Setup Complete</h3>
                            <ul class="text-sm text-green-800 space-y-1">
                                <li>‚Ä¢ Business hours configured</li>
                                <li>‚Ä¢ Services and pricing set</li>
                                <li>‚Ä¢ AI personality customized</li>
                                <li>‚Ä¢ Phone number activated</li>
                                <li>‚Ä¢ 14-day free trial started</li>
                            </ul>
                        </div>

                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                            <h3 class="font-semibold text-blue-900 mb-3">üìä Your Plan</h3>
                            <div class="text-sm text-blue-800 space-y-1">
                                <div><strong>Plan:</strong> <span id="selected-plan">Professional</span></div>
                                <div><strong>Price:</strong> <span id="plan-price">$199/month</span></div>
                                <div><strong>Trial Ends:</strong> <span id="trial-end-date">June 24, 2025</span></div>
                                <div class="text-xs text-blue-600 mt-2">No charge until trial ends</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6">
                        <h4 class="font-semibold text-yellow-900 mb-3">üí≥ Payment Method Required</h4>
                        <p class="text-sm text-yellow-800 mb-4">To activate your trial, we need a payment method. You won't be charged until your trial ends.</p>
                        
                        <div id="payment-section" class="space-y-4">
                            <div class="text-center">
                                <button onclick="setupPayment()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                                    Add Payment Method
                                </button>
                                <p class="text-xs text-gray-500 mt-2">Secure payment processing by Stripe</p>
                            </div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button onclick="launchDashboard()" id="launch-button" class="bg-green-600 text-white px-8 py-4 rounded-lg hover:bg-green-700 font-semibold text-lg disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                            üöÄ Launch Dashboard
                        </button>
                        <p class="text-sm text-gray-500 mt-2">Start managing your AI phone system</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        let currentStep = 1;
        const totalSteps = 5;
        let businessData = {};
        let selectedPersonality = 'friendly';

        // Initialize onboarding
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            populateBusinessHours();
            populateServices();
            setupPersonalitySelection();
        });

        function loadUserData() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            const business = JSON.parse(localStorage.getItem('business') || '{}');
            
            businessData = { ...user, ...business };
            
            // Phone number will be selected during onboarding Step 4
            console.log('üìû Business phone number status:', business.phoneNumber || 'No phone number - will select in Step 4');
            
            if (business.plan) {
                document.getElementById('selected-plan').textContent = capitalizeFirst(business.plan);
                const prices = { starter: '$99', professional: '$199', enterprise: '$399' };
                document.getElementById('plan-price').textContent = prices[business.plan] + '/month';
            }
            
            // Set trial end date (14 days from now)
            const trialEnd = new Date();
            trialEnd.setDate(trialEnd.getDate() + 14);
            document.getElementById('trial-end-date').textContent = trialEnd.toLocaleDateString('en-US', { 
                month: 'long', 
                day: 'numeric', 
                year: 'numeric' 
            });
        }

        function populateBusinessHours() {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const defaultHours = {
                monday: { enabled: true, start: '08:00', end: '18:00', lunchStart: '12:00', lunchEnd: '13:00', emergency: true },
                tuesday: { enabled: true, start: '08:00', end: '18:00', lunchStart: '12:00', lunchEnd: '13:00', emergency: true },
                wednesday: { enabled: true, start: '08:00', end: '18:00', lunchStart: '12:00', lunchEnd: '13:00', emergency: true },
                thursday: { enabled: true, start: '08:00', end: '18:00', lunchStart: '12:00', lunchEnd: '13:00', emergency: true },
                friday: { enabled: true, start: '08:00', end: '18:00', lunchStart: '12:00', lunchEnd: '13:00', emergency: true },
                saturday: { enabled: true, start: '09:00', end: '17:00', lunchStart: '12:00', lunchEnd: '13:00', emergency: false },
                sunday: { enabled: false, start: '10:00', end: '16:00', lunchStart: '12:00', lunchEnd: '13:00', emergency: false }
            };

            const container = document.getElementById('business-hours-container');
            
            days.forEach((day, index) => {
                const dayData = defaultHours[day];
                const row = document.createElement('div');
                row.className = 'grid grid-cols-1 md:grid-cols-7 gap-4 items-center';
                row.innerHTML = `
                    <div class="font-medium text-gray-700">${dayNames[index]}</div>
                    <div class="text-center">
                        <input type="checkbox" ${dayData.enabled ? 'checked' : ''} 
                               onchange="toggleDay('${day}')" 
                               id="enabled-${day}" 
                               class="w-4 h-4 text-blue-600">
                    </div>
                    <div>
                        <input type="time" value="${dayData.start}" 
                               id="start-${day}" 
                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                    </div>
                    <div>
                        <input type="time" value="${dayData.end}" 
                               id="end-${day}" 
                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                    </div>
                    <div>
                        <input type="time" value="${dayData.lunchStart}" 
                               id="lunch-start-${day}" 
                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                    </div>
                    <div>
                        <input type="time" value="${dayData.lunchEnd}" 
                               id="lunch-end-${day}" 
                               class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                    </div>
                    <div class="text-center">
                        <input type="checkbox" ${dayData.emergency ? 'checked' : ''} 
                               id="emergency-${day}" 
                               class="w-4 h-4 text-red-600">
                    </div>
                `;
                container.appendChild(row);
            });
        }

        function populateServices() {
            const defaultServices = [
                { name: 'Emergency Service', baseRate: 150, duration: 60, emergency: true, description: 'Burst pipes, no water, flooding, gas leaks' },
                { name: 'Drain Cleaning', baseRate: 120, duration: 90, emergency: false, description: 'Clogged drains, slow drainage, backups' },
                { name: 'Water Heater Service', baseRate: 100, duration: 180, emergency: false, description: 'Installation, repair, maintenance' },
                { name: 'Pipe Repair', baseRate: 110, duration: 120, emergency: false, description: 'Leaks, pipe replacement, fittings' },
                { name: 'Fixture Installation', baseRate: 95, duration: 90, emergency: false, description: 'Toilets, faucets, sinks, showers' },
                { name: 'Consultation', baseRate: 75, duration: 45, emergency: false, description: 'Estimates, inspection, planning' }
            ];

            const container = document.getElementById('services-container');
            
            defaultServices.forEach((service, index) => {
                const serviceDiv = document.createElement('div');
                serviceDiv.className = 'border border-gray-200 rounded-lg p-4';
                serviceDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <input type="checkbox" checked id="service-enabled-${index}" class="w-4 h-4 text-blue-600">
                            <h3 class="font-semibold text-gray-900">${service.name}</h3>
                            ${service.emergency ? '<span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full">Emergency</span>' : ''}
                        </div>
                        <div class="text-lg font-bold text-green-600">$${service.baseRate}</div>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${service.description}</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Base Rate ($)</label>
                            <input type="number" value="${service.baseRate}" 
                                   id="service-rate-${index}" 
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Duration (minutes)</label>
                            <input type="number" value="${service.duration}" 
                                   id="service-duration-${index}" 
                                   class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Emergency Multiplier</label>
                            <select id="service-multiplier-${index}" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                <option value="1.0">1.0x (No change)</option>
                                <option value="1.5" ${service.emergency ? '' : 'selected'}>1.5x (+50%)</option>
                                <option value="2.0">2.0x (Double)</option>
                                <option value="2.5">2.5x (+150%)</option>
                            </select>
                        </div>
                    </div>
                `;
                container.appendChild(serviceDiv);
            });
        }

        function setupPersonalitySelection() {
            document.querySelectorAll('.personality-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.personality-option').forEach(o => {
                        o.classList.remove('border-blue-500', 'bg-blue-50');
                        o.classList.add('border-gray-200');
                    });
                    
                    this.classList.remove('border-gray-200');
                    this.classList.add('border-blue-500', 'bg-blue-50');
                    
                    selectedPersonality = this.dataset.personality;
                    updateAIPreview();
                });
            });

            // Listen for changes in description and message
            document.getElementById('business-description').addEventListener('input', updateAIPreview);
            document.getElementById('emergency-message').addEventListener('input', updateAIPreview);
        }

        function updateAIPreview() {
            const personalities = {
                professional: "Hello, this is Sarah from BookIt AI services. I can assist you with scheduling your service appointment. How may I help you today?",
                friendly: "Hi there! Thanks for calling! I'm Sarah, your friendly AI assistant. I'd love to help you get your service scheduled. What can I do for you?",
                urgent: "Hello, this is Sarah with emergency services. I'm here to get you immediate help. What's your urgent service need today?"
            };
            
            document.getElementById('ai-preview').textContent = personalities[selectedPersonality];
        }

        function toggleDay(day) {
            const enabled = document.getElementById(`enabled-${day}`).checked;
            const inputs = [`start-${day}`, `end-${day}`, `lunch-start-${day}`, `lunch-end-${day}`, `emergency-${day}`];
            
            inputs.forEach(inputId => {
                document.getElementById(inputId).disabled = !enabled;
            });
        }

        function nextStep() {
            if (currentStep < totalSteps) {
                // Save current step data
                if (currentStep === 1) saveBusinessHours();
                if (currentStep === 2) saveServices();
                if (currentStep === 3) saveAISettings();
                if (currentStep === 4) savePhoneNumber();
                
                currentStep++;
                showStep(currentStep);
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            console.log(`üì± Showing step ${step}`);
            
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Show current step
            const stepElement = document.getElementById(`step-content-${step}`);
            if (stepElement) {
                stepElement.classList.remove('hidden');
                console.log(`üì± ‚úÖ Step ${step} content displayed`);
            } else {
                console.error(`üì± ‚ùå Step ${step} content not found!`);
            }
            
            // Update progress
            updateProgress();
            
            // Update step indicators
            updateStepIndicators();
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `Step ${currentStep} of ${totalSteps}`;
        }

        function updateStepIndicators() {
            for (let i = 1; i <= totalSteps; i++) {
                const stepElement = document.getElementById(`step-${i}`);
                
                if (i < currentStep) {
                    stepElement.className = 'step-completed flex items-center justify-center w-8 h-8 rounded-full text-sm font-semibold';
                } else if (i === currentStep) {
                    stepElement.className = 'step-active flex items-center justify-center w-8 h-8 rounded-full text-sm font-semibold';
                } else {
                    stepElement.className = 'step-pending flex items-center justify-center w-8 h-8 rounded-full text-sm font-semibold';
                }
            }
        }

        function saveBusinessHours() {
            // Implementation would save to backend
            console.log('Saving business hours...');
        }

        function saveServices() {
            // Implementation would save to backend
            console.log('Saving services...');
        }

        function saveAISettings() {
            businessData.aiPersonality = selectedPersonality;
            businessData.businessDescription = document.getElementById('business-description').value;
            businessData.emergencyMessage = document.getElementById('emergency-message').value;
            console.log('Saving AI settings...', businessData);
        }

        function testCall() {
            const phoneNumber = selectedPhoneNumber || businessData.selectedPhoneNumber;
            if (phoneNumber) {
                alert(`üìû Test your AI system:\n\nCall: ${formatPhoneNumber(phoneNumber)}\n\nSay: "I need a plumber for my kitchen sink"\n\nThe AI will offer available appointment times and book the appointment automatically!`);
            } else {
                alert('üìû Please select a phone number first!');
            }
        }

        function setupPayment() {
            // In a real implementation, this would integrate with Stripe
            alert('Payment setup would integrate with Stripe here. For demo purposes, continuing...');
            document.getElementById('launch-button').disabled = false;
            document.getElementById('launch-button').classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
        }

        async function launchDashboard() {
            const launchButton = document.getElementById('launch-button');
            
            // Prevent multiple clicks - check if already processing
            if (launchButton.disabled || launchButton.dataset.processing === 'true') {
                console.log('üö´ Launch already in progress, ignoring click');
                return;
            }
            
            // Disable button and show loading state
            launchButton.disabled = true;
            launchButton.dataset.processing = 'true';
            const originalText = launchButton.textContent;
            launchButton.textContent = 'üîÑ Setting up your system...';
            launchButton.classList.add('opacity-50', 'cursor-not-allowed');
            
            try {
                // Complete onboarding on the backend with selected phone number
                const token = localStorage.getItem('token');
                const business = JSON.parse(localStorage.getItem('business') || '{}');
                
                if (!business.id) {
                    throw new Error('Business ID not found. Please refresh and try again.');
                }
                
                console.log(`üöÄ Completing onboarding for business ${business.id}`);
                console.log(`üìû Selected phone number: ${businessData.selectedPhoneNumber || 'None selected - will auto-assign'}`);
                console.log(`üìû Area code: ${businessData.areaCode || 'Not specified'}`);
                console.log(`üìû Business data:`, businessData);
                
                // Generate unique request ID for deduplication
                const requestId = `onboarding-${business.id}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                const response = await fetch(`/api/businesses/${business.id}/complete-onboarding`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'X-Request-ID': requestId
                    },
                    body: JSON.stringify({
                        selectedPhoneNumber: businessData.selectedPhoneNumber,
                        areaCode: businessData.areaCode,
                        businessData: businessData,
                        requestId: requestId
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to complete onboarding');
                }
                
                const result = await response.json();
                console.log(`‚úÖ Onboarding completed successfully:`, result);
                
                // Update business data with the activated phone number
                const updatedBusiness = { ...business, phone_number: result.phoneNumber, onboarding_completed: true };
                localStorage.setItem('business', JSON.stringify(updatedBusiness));
                
                // Mark onboarding as complete
                localStorage.setItem('onboarding_complete', 'true');
                
                // Show success message
                alert(`üéâ Success! Your AI phone system is now active!\n\nYour business phone number: ${result.phoneNumber}\n\nRedirecting to your dashboard...`);
                
                // Redirect to dashboard
                window.location.href = '/dashboard';
                
            } catch (error) {
                console.error('‚ùå Error completing onboarding:', error);
                
                // Re-enable button on error
                launchButton.disabled = false;
                launchButton.dataset.processing = 'false';
                launchButton.textContent = originalText;
                launchButton.classList.remove('opacity-50', 'cursor-not-allowed');
                
                alert(`Error completing setup: ${error.message}\n\nPlease try again or contact support.`);
            }
        }

        function formatPhoneNumber(phoneNumber) {
            // Format phone number for display
            const cleaned = phoneNumber.replace(/\D/g, '');
            const match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/);
            if (match) {
                return `(${match[1]}) ${match[2]}-${match[3]}`;
            }
            return phoneNumber;
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Phone Number Selection Functions
        let selectedPhoneNumber = null;
        let currentAreaCode = null;
        let availableNumbers = [];

        async function searchByAreaCode(areaCode) {
            currentAreaCode = areaCode;
            
            // Update UI to show selected area code
            document.querySelectorAll('.area-code-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-white', 'text-blue-800');
            });
            
            // Highlight selected area code button
            event.target.classList.remove('bg-white', 'text-blue-800');
            event.target.classList.add('bg-blue-600', 'text-white');
            
            await searchAvailableNumbers(areaCode);
        }

        async function searchCustomAreaCode() {
            const areaCode = document.getElementById('custom-area-code').value.trim();
            
            if (!areaCode || areaCode.length !== 3 || !/^\d{3}$/.test(areaCode)) {
                alert('Please enter a valid 3-digit area code (e.g., 555)');
                return;
            }
            
            currentAreaCode = areaCode;
            await searchAvailableNumbers(areaCode);
        }

        async function searchAvailableNumbers(areaCode) {
            try {
                // Show loading state
                document.getElementById('loading-numbers').classList.remove('hidden');
                document.getElementById('available-numbers-section').classList.add('hidden');
                document.getElementById('selected-number-preview').classList.add('hidden');
                
                console.log(`üîç Searching for numbers in area code ${areaCode}...`);
                
                const token = localStorage.getItem('token');
                const business = JSON.parse(localStorage.getItem('business') || '{}');
                
                if (!business.id) {
                    throw new Error('Business ID not found. Please refresh and try again.');
                }
                
                const response = await fetch(`/api/businesses/${business.id}/available-phone-numbers?areaCode=${areaCode}&limit=8`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to search phone numbers');
                }
                
                const data = await response.json();
                availableNumbers = data.availableNumbers || data || []; // Handle both old and new format
                
                console.log(`üìû Found ${availableNumbers.length} available numbers`);
                console.log(`üìû Search info:`, data.searchInfo || 'No search info available');
                
                // Hide loading, show results
                document.getElementById('loading-numbers').classList.add('hidden');
                displayAvailableNumbers();
                
            } catch (error) {
                console.error('‚ùå Error searching phone numbers:', error);
                document.getElementById('loading-numbers').classList.add('hidden');
                alert(`Error searching phone numbers: ${error.message}`);
            }
        }

        function displayAvailableNumbers() {
            const container = document.getElementById('available-numbers-list');
            const section = document.getElementById('available-numbers-section');
            const display = document.getElementById('selected-area-code-display');
            
            display.textContent = `Area Code: ${currentAreaCode}`;
            
            if (availableNumbers.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-6 text-gray-500">
                        <div class="text-2xl mb-2">üòî</div>
                        <p>No numbers available in area code ${currentAreaCode}</p>
                        <p class="text-sm">Please try a different area code</p>
                    </div>
                `;
            } else {
                container.innerHTML = availableNumbers.map(number => `
                    <div class="phone-number-option border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-colors" 
                         onclick="selectPhoneNumber('${number.phoneNumber}')">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-lg font-semibold text-gray-900">${formatPhoneNumber(number.phoneNumber)}</div>
                                <div class="text-sm text-gray-600">${number.locality || 'Local Number'}, ${number.region || currentAreaCode}</div>
                                ${number.capabilities?.voice ? '<span class="inline-block bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full mr-1">Voice</span>' : ''}
                                ${number.capabilities?.sms ? '<span class="inline-block bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full">SMS</span>' : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium text-green-600">Included in Plan</div>
                                <div class="text-xs text-gray-500">No additional cost</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            section.classList.remove('hidden');
        }

        function selectPhoneNumber(phoneNumber) {
            selectedPhoneNumber = phoneNumber;
            
            // Update visual selection
            document.querySelectorAll('.phone-number-option').forEach(option => {
                option.classList.remove('border-green-500', 'bg-green-50');
                option.classList.add('border-gray-200');
            });
            
            // Highlight selected number
            event.currentTarget.classList.remove('border-gray-200');
            event.currentTarget.classList.add('border-green-500', 'bg-green-50');
            
            // Show selected number preview
            document.getElementById('selected-phone-display').textContent = formatPhoneNumber(phoneNumber);
            document.getElementById('selected-number-preview').classList.remove('hidden');
            document.getElementById('no-selection-warning').classList.add('hidden');
            
            // Enable continue button
            document.getElementById('continue-with-number').disabled = false;
            document.getElementById('continue-with-number').classList.remove('disabled:bg-gray-400', 'disabled:cursor-not-allowed');
            
            console.log(`üìû Selected phone number: ${phoneNumber}`);
        }

        async function searchMoreNumbers() {
            if (currentAreaCode) {
                await searchAvailableNumbers(currentAreaCode);
            }
        }

        async function continueWithSelectedNumber() {
            if (!selectedPhoneNumber) {
                document.getElementById('no-selection-warning').classList.remove('hidden');
                return;
            }
            
            try {
                // Save selected phone number
                businessData.selectedPhoneNumber = selectedPhoneNumber;
                businessData.areaCode = currentAreaCode;
                
                console.log(`üìû Continuing with selected number: ${selectedPhoneNumber}`);
                
                // Move to next step
                nextStep();
                
            } catch (error) {
                console.error('‚ùå Error continuing with selected number:', error);
                alert(`Error: ${error.message}`);
            }
        }

        // Update the save phone number function to use the selected number
        function savePhoneNumber() {
            if (selectedPhoneNumber) {
                businessData.phoneNumber = selectedPhoneNumber;
                businessData.areaCode = currentAreaCode;
                console.log('üìû Saving selected phone number:', selectedPhoneNumber);
            }
        }

        // Initialize
        updateProgress();
        updateStepIndicators();
    </script>
</body>
</html>