<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallCatcher Calendar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .calendar-day {
            min-height: 100px;
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            background-color: #f8fafc;
        }
        
        .calendar-day.selected {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        
        .calendar-day.today {
            background-color: #fef3c7;
            border-color: #f59e0b;
        }
        
        .appointment-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }
        
        .emergency { background-color: #ef4444; }
        .regular { background-color: #3b82f6; }
        
        .notification-badge {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">CallCatcher Calendar</h1>
                    <p class="text-gray-600">AI-powered appointment management</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <span class="text-2xl cursor-pointer" onclick="refreshNotifications()">üîî</span>
                        <span id="notification-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center notification-badge hidden">0</span>
                    </div>
                    <button onclick="goToToday()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        Today
                    </button>
                    <button onclick="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Stats Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üìû</span>
                    <div>
                        <p class="text-2xl font-bold text-gray-900" id="total-appointments">0</p>
                        <p class="text-gray-600">Total Appointments</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üìÖ</span>
                    <div>
                        <p class="text-2xl font-bold text-gray-900" id="selected-day-appointments">0</p>
                        <p class="text-gray-600" id="selected-day-label">Selected Day</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üí∞</span>
                    <div>
                        <p class="text-2xl font-bold text-gray-900" id="selected-day-revenue">$0</p>
                        <p class="text-gray-600">Selected Day Revenue</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">ü§ñ</span>
                    <div>
                        <p class="text-2xl font-bold text-gray-900" id="ai-bookings">0</p>
                        <p class="text-gray-600">AI Bookings</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Calendar View -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <!-- Calendar Header -->
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-900" id="calendar-month-year">
                            June 2025
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="previousMonth()" class="px-4 py-2 border rounded hover:bg-gray-50 font-medium">
                                ‚Üê Previous
                            </button>
                            <button onclick="nextMonth()" class="px-4 py-2 border rounded hover:bg-gray-50 font-medium">
                                Next ‚Üí
                            </button>
                        </div>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-1 mb-2">
                        <div class="p-3 text-center text-sm font-semibold text-gray-700 bg-gray-100 rounded">Sun</div>
                        <div class="p-3 text-center text-sm font-semibold text-gray-700 bg-gray-100 rounded">Mon</div>
                        <div class="p-3 text-center text-sm font-semibold text-gray-700 bg-gray-100 rounded">Tue</div>
                        <div class="p-3 text-center text-sm font-semibold text-gray-700 bg-gray-100 rounded">Wed</div>
                        <div class="p-3 text-center text-sm font-semibold text-gray-700 bg-gray-100 rounded">Thu</div>
                        <div class="p-3 text-center text-sm font-semibold text-gray-700 bg-gray-100 rounded">Fri</div>
                        <div class="p-3 text-center text-sm font-semibold text-gray-700 bg-gray-100 rounded">Sat</div>
                    </div>

                    <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                        <!-- Calendar days will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Selected Day Details -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4" id="selected-date-header">
                        Today's Schedule
                    </h3>
                    <div id="selected-day-appointments-list" class="space-y-3">
                        <div class="text-center py-4 text-gray-500">
                            Select a date to view appointments
                        </div>
                    </div>
                </div>

                <!-- Available Slots for Selected Day -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Available Slots</h3>
                    <div id="selected-day-available-slots" class="grid grid-cols-2 gap-2">
                        <div class="text-center py-4 text-gray-500 col-span-2">
                            Select a date to view availability
                        </div>
                    </div>
                    <div class="mt-3 text-xs text-gray-500 text-center">
                        AI offers these times to callers
                    </div>
                </div>

                <!-- Live Notifications -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Live Activity</h3>
                    <div id="notifications-list" class="space-y-3">
                        <div class="text-center py-4 text-gray-500">
                            No new notifications
                        </div>
                    </div>
                </div>

                <!-- Phone System Info -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Phone System</h3>
                    <div class="space-y-3">
                        <div class="text-sm text-gray-600">
                            <strong>Phone Number:</strong><br>
                            <span class="text-lg font-mono">(844) 540-1735</span>
                        </div>
                        <div class="text-sm text-gray-600">
                            <strong>Status:</strong> <span class="text-green-600">‚óè Active</span>
                        </div>
                        <button onclick="testCall()" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
                            Test Call System
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentDate = new Date();
        let selectedDate = new Date();
        let appointments = [];
        let notifications = [];
        let stats = {};

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            selectedDate = new Date(); // Start with today selected
            refreshData();
            renderCalendar();
            // Auto-refresh every 30 seconds
            setInterval(() => {
                refreshData();
                renderCalendar();
            }, 30000);
        });

        // Calendar navigation
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            selectedDate = new Date();
            renderCalendar();
            loadSelectedDayData();
        }

        // Render calendar
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Update month/year header
            document.getElementById('calendar-month-year').textContent = 
                currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Calculate calendar days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay()); // Start from Sunday

            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';

            // Generate 6 weeks of calendar
            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + (week * 7) + day);
                    
                    const dayElement = createDayElement(date, month);
                    calendarGrid.appendChild(dayElement);
                }
            }
        }

        // Create calendar day element
        function createDayElement(date, currentMonth) {
            const dayDiv = document.createElement('div');
            const isCurrentMonth = date.getMonth() === currentMonth;
            const isToday = date.toDateString() === new Date().toDateString();
            const isSelected = date.toDateString() === selectedDate.toDateString();
            
            // Get appointments for this day
            const dayAppointments = getDayAppointments(date);
            const dayRevenue = dayAppointments.reduce((sum, apt) => sum + (apt.estimatedRevenue || 0), 0);

            dayDiv.className = `calendar-day border border-gray-200 rounded p-2 cursor-pointer ${
                isCurrentMonth ? 'bg-white' : 'bg-gray-50 text-gray-400'
            } ${isToday ? 'today border-2' : ''} ${isSelected ? 'selected border-2' : ''}`;
            
            dayDiv.onclick = () => selectDate(date);

            // Day number
            const dayNumber = document.createElement('div');
            dayNumber.className = 'font-semibold text-sm mb-1';
            dayNumber.textContent = date.getDate();
            dayDiv.appendChild(dayNumber);

            // Appointments indicators
            if (dayAppointments.length > 0) {
                const appointmentsDiv = document.createElement('div');
                appointmentsDiv.className = 'space-y-1';

                // Show appointment dots
                dayAppointments.slice(0, 3).forEach(apt => {
                    const aptDiv = document.createElement('div');
                    aptDiv.className = 'text-xs flex items-center';
                    
                    const dot = document.createElement('span');
                    dot.className = `appointment-dot ${apt.service || 'regular'}`;
                    
                    const time = new Date(apt.startTime).toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    });
                    
                    aptDiv.appendChild(dot);
                    aptDiv.appendChild(document.createTextNode(time));
                    appointmentsDiv.appendChild(aptDiv);
                });

                // Show more indicator
                if (dayAppointments.length > 3) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'text-xs text-gray-500';
                    moreDiv.textContent = `+${dayAppointments.length - 3} more`;
                    appointmentsDiv.appendChild(moreDiv);
                }

                dayDiv.appendChild(appointmentsDiv);

                // Revenue indicator
                if (dayRevenue > 0) {
                    const revenueDiv = document.createElement('div');
                    revenueDiv.className = 'text-xs font-medium text-green-600 mt-1';
                    revenueDiv.textContent = `$${dayRevenue}`;
                    dayDiv.appendChild(revenueDiv);
                }
            }

            return dayDiv;
        }

        // Select a date
        function selectDate(date) {
            selectedDate = new Date(date);
            renderCalendar(); // Re-render to show selection
            loadSelectedDayData();
        }

        // Load data for selected day
        function loadSelectedDayData() {
            const dateStr = selectedDate.toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'long', 
                day: 'numeric',
                year: 'numeric'
            });
            
            document.getElementById('selected-date-header').textContent = dateStr;
            document.getElementById('selected-day-label').textContent = 
                selectedDate.toDateString() === new Date().toDateString() ? "Today's Appointments" : "Selected Day";

            // Load appointments for selected day
            const dayAppointments = getDayAppointments(selectedDate);
            renderSelectedDayAppointments(dayAppointments);

            // Load available slots for selected day
            loadAvailableSlotsForDate(selectedDate);

            // Update stats for selected day
            const dayRevenue = dayAppointments.reduce((sum, apt) => sum + (apt.estimatedRevenue || 0), 0);
            document.getElementById('selected-day-appointments').textContent = dayAppointments.length;
            document.getElementById('selected-day-revenue').textContent = `$${dayRevenue}`;
        }

        // Get appointments for a specific day
        function getDayAppointments(date) {
            return appointments.filter(apt => {
                const aptDate = new Date(apt.startTime);
                return aptDate.toDateString() === date.toDateString();
            }).sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
        }

        // Render selected day appointments
        function renderSelectedDayAppointments(dayAppointments) {
            const container = document.getElementById('selected-day-appointments-list');
            
            if (dayAppointments.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-500">No appointments scheduled</div>';
                return;
            }

            container.innerHTML = dayAppointments.map(apt => {
                const startTime = new Date(apt.startTime);
                const timeString = startTime.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });

                return `
                    <div class="border rounded-lg p-3 hover:bg-gray-50">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="font-semibold">${timeString}</span>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${apt.status === 'confirmed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                                ${apt.status}
                            </span>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${apt.service === 'emergency' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">
                                ${apt.service}
                            </span>
                        </div>
                        <div class="text-sm font-medium text-gray-900 mb-1">
                            üë§ ${apt.customerName}
                        </div>
                        <div class="text-sm text-gray-600 mb-1">
                            üìû ${apt.customerPhone}
                        </div>
                        <div class="text-sm text-gray-800 mb-2">
                            <strong>Issue:</strong> ${apt.issue || 'Not specified'}
                        </div>
                        <div class="flex items-center gap-4 text-xs text-gray-500">
                            <span>üí∞ $${apt.estimatedRevenue}</span>
                            <span>üì± ${apt.bookedVia}</span>
                            <span>‚è±Ô∏è ${apt.duration} min</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load available slots for selected date
        async function loadAvailableSlotsForDate(date) {
            try {
                const dateParam = date.toISOString().split('T')[0];
                const response = await fetch(`/api/available-slots?date=${dateParam}`);
                const slots = await response.json();
                renderSelectedDayAvailableSlots(slots);
            } catch (error) {
                console.error('Error loading available slots:', error);
            }
        }

        // Render available slots for selected day
        function renderSelectedDayAvailableSlots(slots) {
            const container = document.getElementById('selected-day-available-slots');
            
            if (slots.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-500 col-span-2">No slots available</div>';
                return;
            }

            container.innerHTML = slots.slice(0, 8).map(slot => `
                <div class="text-center py-2 px-3 bg-green-50 text-green-700 rounded border border-green-200 text-sm">
                    ${slot.display}
                </div>
            `).join('');
        }

        // Refresh all data
        async function refreshData() {
            try {
                await Promise.all([
                    loadAllAppointments(),
                    loadNotifications(),
                    loadStats()
                ]);
                loadSelectedDayData(); // Refresh selected day data
                console.log('Data refreshed successfully');
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        // Load all appointments
        async function loadAllAppointments() {
            try {
                const response = await fetch('/api/appointments');
                appointments = await response.json();
            } catch (error) {
                console.error('Error loading appointments:', error);
                appointments = [];
            }
        }

        // Load notifications
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications');
                notifications = await response.json();
                renderNotifications();
                updateNotificationBadge();
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Load stats
        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                stats = await response.json();
                renderStats();
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Render notifications
        function renderNotifications() {
            const container = document.getElementById('notifications-list');
            
            if (notifications.length === 0) {
                container.innerHTML = '<div class="text-center py-4 text-gray-500">No new notifications</div>';
                return;
            }

            container.innerHTML = notifications.slice(0, 5).map(notif => `
                <div class="p-3 rounded border-l-4 ${notif.type === 'new_booking' ? 'border-blue-500 bg-blue-50' : 'border-orange-500 bg-orange-50'}">
                    <div class="text-sm font-medium text-gray-900">
                        ${notif.message}
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        ${notif.time}
                    </div>
                </div>
            `).join('');
        }

        // Render stats
        function renderStats() {
            document.getElementById('total-appointments').textContent = stats.totalAppointments || 0;
            document.getElementById('ai-bookings').textContent = stats.aiBookings || 0;
        }

        // Update notification badge
        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Refresh notifications
        function refreshNotifications() {
            loadNotifications();
        }

        // Test call functionality
        function testCall() {
            alert(`üìû Test your AI system:\n\nCall: (844) 540-1735\n\nSay: "I need a plumber for my kitchen sink"\n\nThe AI will offer available appointment times and book the appointment automatically!`);
        }

        // Auto-refresh when tab becomes visible
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                refreshData();
                renderCalendar();
            }
        });
    </script>
</body>
</html>
