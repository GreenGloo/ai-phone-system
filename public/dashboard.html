<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallCatcher Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .notification-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .calendar-day {
            min-height: 80px;
            transition: all 0.2s ease;
        }
        .calendar-day:hover {
            background-color: #f8fafc;
        }
        .calendar-day.selected {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        .calendar-day.today {
            background-color: #fef3c7;
            border-color: #f59e0b;
        }
        .appointment-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }
        .emergency { background-color: #ef4444; }
        .regular { background-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">üìû CallCatcher</h1>
                    <span id="business-name" class="ml-4 text-gray-600">Loading...</span>
                </div>
                <div class="flex items-center gap-4">
                    <nav class="flex items-center gap-4 mr-6">
                        <a href="/dashboard" class="text-blue-600 font-medium">Dashboard</a>
                        <button onclick="showServiceManager()" class="text-gray-600 hover:text-gray-900">Services</button>
                        <button onclick="showAnalytics()" class="text-gray-600 hover:text-gray-900">Analytics</button>
                        <button onclick="showSettings()" class="text-gray-600 hover:text-gray-900">Settings</button>
                    </nav>
                    <div class="relative">
                        <span class="text-2xl cursor-pointer" onclick="toggleNotifications()">üîî</span>
                        <span id="notification-badge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center notification-badge hidden">0</span>
                    </div>
                    <button onclick="logout()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Quick Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="stat-card bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                            <span class="text-blue-600 text-lg">üìû</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Today's Calls</dt>
                            <dd id="today-calls" class="text-lg font-medium text-gray-900">0</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                            <span class="text-green-600 text-lg">üìÖ</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Appointments Booked</dt>
                            <dd id="appointments-booked" class="text-lg font-medium text-gray-900">0</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-100 rounded-lg flex items-center justify-center">
                            <span class="text-yellow-600 text-lg">üí∞</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Today's Revenue</dt>
                            <dd id="today-revenue" class="text-lg font-medium text-gray-900">$0</dd>
                        </dl>
                    </div>
                </div>
            </div>

            <div class="stat-card bg-white rounded-lg p-6 shadow-sm">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                            <span class="text-purple-600 text-lg">üìà</span>
                        </div>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Conversion Rate</dt>
                            <dd id="conversion-rate" class="text-lg font-medium text-gray-900">0%</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Calendar Section -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900">üìÖ Calendar</h2>
                        <div class="flex gap-2">
                            <button onclick="previousMonth()" class="px-3 py-1 border rounded hover:bg-gray-50">‚Üê</button>
                            <button onclick="goToToday()" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">Today</button>
                            <button onclick="nextMonth()" class="px-3 py-1 border rounded hover:bg-gray-50">‚Üí</button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <h3 id="calendar-month-year" class="text-lg font-semibold text-gray-700">June 2025</h3>
                    </div>

                    <!-- Calendar Grid -->
                    <div class="grid grid-cols-7 gap-1 mb-2">
                        <div class="p-2 text-center text-xs font-semibold text-gray-700">Sun</div>
                        <div class="p-2 text-center text-xs font-semibold text-gray-700">Mon</div>
                        <div class="p-2 text-center text-xs font-semibold text-gray-700">Tue</div>
                        <div class="p-2 text-center text-xs font-semibold text-gray-700">Wed</div>
                        <div class="p-2 text-center text-xs font-semibold text-gray-700">Thu</div>
                        <div class="p-2 text-center text-xs font-semibold text-gray-700">Fri</div>
                        <div class="p-2 text-center text-xs font-semibold text-gray-700">Sat</div>
                    </div>

                    <div id="calendar-grid" class="grid grid-cols-7 gap-1">
                        <!-- Calendar days will be inserted here -->
                    </div>
                </div>

                <!-- Recent Appointments -->
                <div class="bg-white rounded-lg shadow-sm p-6 mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-900">üìã Recent Appointments</h2>
                        <button onclick="refreshAppointments()" class="text-blue-600 hover:text-blue-800 text-sm">Refresh</button>
                    </div>
                    <div id="recent-appointments" class="space-y-3">
                        <div class="text-center py-8 text-gray-500">Loading appointments...</div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Phone System Status -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">üìû Phone System</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Status</span>
                            <span class="text-green-600 font-medium">‚óè Active</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Number</span>
                            <span id="phone-number" class="font-mono text-sm">Loading...</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-600">Calls This Month</span>
                            <span id="monthly-calls" class="font-medium">0</span>
                        </div>
                        <button onclick="testCall()" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 text-sm">
                            Test Call System
                        </button>
                        <button onclick="testSMS()" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 text-sm mt-2">
                            Test SMS Notifications
                        </button>
                    </div>
                </div>

                <!-- Live Activity -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">‚ö° Live Activity</h3>
                    <div id="live-activity" class="space-y-3">
                        <div class="text-center py-4 text-gray-500 text-sm">No recent activity</div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">üöÄ Quick Actions</h3>
                    <div class="space-y-2">
                        <button onclick="viewAnalytics()" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 text-sm">
                            üìä View Analytics
                        </button>
                        <button onclick="manageServices()" class="w-full bg-purple-600 text-white py-2 px-4 rounded hover:bg-purple-700 text-sm">
                            üîß Manage Services
                        </button>
                        <button onclick="manageTeam()" class="w-full bg-orange-600 text-white py-2 px-4 rounded hover:bg-orange-700 text-sm">
                            üë• Team Management
                        </button>
                        <button onclick="customizeAI()" class="w-full bg-indigo-600 text-white py-2 px-4 rounded hover:bg-indigo-700 text-sm">
                            ü§ñ Customize AI
                        </button>
                        <button onclick="viewBilling()" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 text-sm">
                            üí≥ Billing & Usage
                        </button>
                    </div>
                </div>

                <!-- Account Info -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">üë§ Account</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Plan</span>
                            <span id="current-plan" class="font-medium">Professional</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Trial Ends</span>
                            <span id="trial-end" class="font-medium">June 24</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Calls Used</span>
                            <span id="calls-used" class="font-medium">0/500</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Dropdown -->
    <div id="notifications-dropdown" class="fixed top-16 right-4 bg-white rounded-lg shadow-lg border z-50 hidden" style="width: 320px;">
        <div class="p-4 border-b">
            <div class="flex items-center justify-between">
                <h3 class="font-semibold text-gray-900">Notifications</h3>
                <button onclick="toggleNotifications()" class="text-gray-400 hover:text-gray-600">‚úï</button>
            </div>
        </div>
        <div id="notifications-list" class="max-h-80 overflow-y-auto">
            <div class="p-4 text-center text-gray-500 text-sm">No new notifications</div>
        </div>
    </div>

    <!-- Service Manager Modal -->
    <div id="service-manager-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-900">üîß Manage Services</h3>
                        <button onclick="hideServiceManager()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="flex flex-col" style="height: 70vh;">
                    <div class="p-6 border-b">
                        <div class="flex justify-between items-center">
                            <p class="text-gray-600">Configure the services your AI can offer to customers</p>
                            <button onclick="addNewService()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                + Add New Service
                            </button>
                        </div>
                    </div>

                    <div class="p-6 flex-1 overflow-y-auto">
                        <div id="services-list" class="space-y-4">
                            <!-- Services will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Service Modal -->
    <div id="service-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h3 id="service-edit-title" class="text-xl font-bold text-gray-900">Add New Service</h3>
                        <button onclick="hideServiceEdit()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <form id="service-form" class="p-6 space-y-4">
                    <input type="hidden" id="service-id" value="">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Service Name</label>
                        <input type="text" id="service-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Emergency Repair">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="service-description" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="What does this service include?"></textarea>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Base Rate ($)</label>
                            <input type="number" id="service-rate" required min="0" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Duration (min)</label>
                            <input type="number" id="service-duration" required min="15" step="15" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Emergency Multiplier</label>
                            <select id="service-multiplier" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                                <option value="1.0">1.0x (No change)</option>
                                <option value="1.5">1.5x (+50%)</option>
                                <option value="2.0">2.0x (Double)</option>
                                <option value="2.5">2.5x (+150%)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Travel Buffer (min)</label>
                            <input type="number" id="service-buffer" required min="0" step="15" value="30" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="service-emergency" class="w-4 h-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <span class="ml-2 text-sm text-gray-700">Emergency Service</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="service-active" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-sm text-gray-700">Active</span>
                        </label>
                    </div>
                    
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="hideServiceEdit()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Save Service
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Team Manager Modal -->
    <div id="team-manager-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-900">üë• Team Management</h3>
                        <button onclick="hideTeamManager()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <p class="text-gray-600">Manage team members and notification settings (Enterprise feature)</p>
                        <button onclick="addTeamMember()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            + Add Team Member
                        </button>
                    </div>

                    <div id="team-members-list" class="space-y-4">
                        <!-- Team members will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Team Member Modal -->
    <div id="team-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center">
                        <h3 id="team-edit-title" class="text-xl font-bold text-gray-900">Add Team Member</h3>
                        <button onclick="hideTeamEdit()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <form id="team-form" class="p-6 space-y-4">
                    <input type="hidden" id="team-member-id" value="">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                        <input type="text" id="team-name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="John Smith">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="team-email" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="john@email.com">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mobile Phone *</label>
                        <input type="tel" id="team-phone" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="(555) 123-4567">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Role</label>
                        <select id="team-role" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <option value="technician">Technician</option>
                            <option value="manager">Manager</option>
                            <option value="owner">Owner</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Specialties</label>
                        <input type="text" id="team-specialties" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="plumbing, electrical, hvac (comma separated)">
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="team-notifications" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="team-notifications" class="ml-2 text-sm text-gray-700">Receive SMS notifications</label>
                    </div>
                    
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="hideTeamEdit()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Save Team Member
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentDate = new Date();
        let selectedDate = new Date();
        let appointments = [];
        let businessData = {};
        let stats = {};

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadBusinessData();
            loadDashboardData();
            renderCalendar();
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadDashboardData();
            }, 30000);
        });

        function checkAuthentication() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }
        }

        function loadBusinessData() {
            const business = JSON.parse(localStorage.getItem('business') || '{}');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            // Don't let user.id overwrite business.id!
            businessData = { 
                ...business, 
                user: user,
                userId: user.id,
                userEmail: user.email
            };
            
            console.log('Business data loaded:', businessData);
            console.log('Business from localStorage:', business);
            console.log('User from localStorage:', user);
            
            if (business.name) {
                document.getElementById('business-name').textContent = business.name;
            }
            
            if (business.phone_number) {
                document.getElementById('phone-number').textContent = formatPhoneNumber(business.phone_number);
            } else {
                console.log('No phone number found in business data:', business);
            }
            
            if (business.plan) {
                document.getElementById('current-plan').textContent = capitalizeFirst(business.plan);
            }
        }

        async function loadDashboardData() {
            try {
                const token = localStorage.getItem('token');
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                };

                // If we don't have business ID, load businesses from API
                if (!businessData.id) {
                    console.log('No business ID found, loading from API...');
                    const businessesResponse = await fetch('/api/businesses', { headers });
                    if (businessesResponse.ok) {
                        const businesses = await businessesResponse.json();
                        if (businesses.length > 0) {
                            businessData = businesses[0];
                            localStorage.setItem('business', JSON.stringify(businessData));
                            console.log('Business data loaded from API:', businessData);
                            
                            // Update UI
                            if (businessData.name) {
                                document.getElementById('business-name').textContent = businessData.name;
                            }
                        }
                    }
                }

                // Load appointments if we have business ID
                if (businessData.id) {
                    const appointmentsResponse = await fetch(`/api/businesses/${businessData.id}/appointments`, { headers });
                    if (appointmentsResponse.ok) {
                        appointments = await appointmentsResponse.json();
                        await updatePastAppointments(); // Update past appointments status
                        renderRecentAppointments();
                        updateStats();
                    }
                }

                // Load notifications
                loadNotifications();

            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        function updateStats() {
            const today = new Date();
            const todayStr = today.toDateString();
            
            // Filter today's data
            const todayAppointments = appointments.filter(apt => 
                new Date(apt.start_time).toDateString() === todayStr
            );
            
            const todayRevenue = todayAppointments.reduce((sum, apt) => 
                sum + (parseFloat(apt.estimated_revenue) || 0), 0
            );
            
            // Update UI
            document.getElementById('today-calls').textContent = todayAppointments.length;
            document.getElementById('appointments-booked').textContent = todayAppointments.length;
            document.getElementById('today-revenue').textContent = `$${todayRevenue.toFixed(2)}`;
            
            // Calculate conversion rate (simplified)
            const conversionRate = todayAppointments.length > 0 ? 
                Math.round((todayAppointments.length / Math.max(todayAppointments.length * 1.2, 1)) * 100) : 0;
            document.getElementById('conversion-rate').textContent = `${conversionRate}%`;
            
            // Update monthly stats
            const monthlyAppointments = appointments.filter(apt => {
                const aptDate = new Date(apt.start_time);
                return aptDate.getMonth() === today.getMonth() && 
                       aptDate.getFullYear() === today.getFullYear();
            });
            
            document.getElementById('monthly-calls').textContent = monthlyAppointments.length;
            document.getElementById('calls-used').textContent = `${monthlyAppointments.length}/500`;
        }

        function renderRecentAppointments() {
            const container = document.getElementById('recent-appointments');
            
            if (appointments.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">No appointments yet</div>';
                return;
            }

            // Filter to show only scheduled/active appointments, sort by most recent and take first 5
            const recentAppointments = appointments
                .filter(apt => apt.status === 'scheduled' || apt.status === 'confirmed')
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
                .slice(0, 5);

            container.innerHTML = recentAppointments.map(apt => {
                const startTime = new Date(apt.start_time);
                const timeString = startTime.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });

                const statusColor = apt.status === 'scheduled' ? 'bg-blue-100 text-blue-700' : 
                                  apt.status === 'confirmed' ? 'bg-green-100 text-green-700' : 
                                  'bg-yellow-100 text-yellow-700';

                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50">
                        <div class="flex items-center justify-between mb-2">
                            <div class="font-medium text-gray-900">${apt.customer_name}</div>
                            <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColor}">
                                ${apt.status}
                            </span>
                        </div>
                        <div class="text-sm text-gray-600 mb-1">
                            üìû ${apt.customer_phone}
                        </div>
                        <div class="text-sm text-gray-600 mb-1">
                            üîß ${apt.service_name}
                        </div>
                        <div class="flex items-center justify-between text-xs text-gray-500">
                            <span>üìÖ ${timeString}</span>
                            <span>üí∞ $${apt.estimated_revenue}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Calendar functions
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('calendar-month-year').textContent = 
                currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';

            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + (week * 7) + day);
                    
                    const dayElement = createDayElement(date, month);
                    calendarGrid.appendChild(dayElement);
                }
            }
        }

        function createDayElement(date, currentMonth) {
            const dayDiv = document.createElement('div');
            const isCurrentMonth = date.getMonth() === currentMonth;
            const isToday = date.toDateString() === new Date().toDateString();
            const isSelected = date.toDateString() === selectedDate.toDateString();
            
            const dayAppointments = getDayAppointments(date);

            dayDiv.className = `calendar-day border border-gray-200 rounded p-2 cursor-pointer ${
                isCurrentMonth ? 'bg-white' : 'bg-gray-50 text-gray-400'
            } ${isToday ? 'today border-2' : ''} ${isSelected ? 'selected border-2' : ''}`;
            
            dayDiv.onclick = () => selectDate(date);

            // Day number
            const dayNumber = document.createElement('div');
            dayNumber.className = 'font-semibold text-xs mb-1';
            dayNumber.textContent = date.getDate();
            dayDiv.appendChild(dayNumber);

            // Appointment indicators
            if (dayAppointments.length > 0) {
                const dotsDiv = document.createElement('div');
                dotsDiv.className = 'flex flex-wrap gap-1';
                
                dayAppointments.slice(0, 3).forEach(apt => {
                    const dot = document.createElement('div');
                    dot.className = `appointment-dot ${apt.service_name?.includes('Emergency') ? 'emergency' : 'regular'}`;
                    dotsDiv.appendChild(dot);
                });

                if (dayAppointments.length > 3) {
                    const moreText = document.createElement('div');
                    moreText.className = 'text-xs text-gray-500';
                    moreText.textContent = `+${dayAppointments.length - 3}`;
                    dotsDiv.appendChild(moreText);
                }

                dayDiv.appendChild(dotsDiv);
            }

            return dayDiv;
        }

        function getDayAppointments(date) {
            return appointments.filter(apt => {
                const aptDate = new Date(apt.start_time);
                return aptDate.toDateString() === date.toDateString();
            });
        }

        function selectDate(date) {
            selectedDate = new Date(date);
            renderCalendar();
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            selectedDate = new Date();
            renderCalendar();
        }

        // Notification functions
        function toggleNotifications() {
            const dropdown = document.getElementById('notifications-dropdown');
            dropdown.classList.toggle('hidden');
        }

        async function loadNotifications() {
            let notifications = [];
            
            try {
                // Load real notifications from recent appointments
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                const recentAppointments = appointments.filter(apt => {
                    const aptDate = new Date(apt.created_at || apt.start_time);
                    return aptDate >= yesterday;
                });
                
                notifications = recentAppointments.map((apt, index) => ({
                    id: apt.id || index,
                    type: 'new_booking',
                    message: `New appointment: ${apt.customer_name} - ${apt.service_name}`,
                    time: getTimeAgo(apt.created_at || apt.start_time),
                    read: false
                }));
                
                // Add a system notification if no real ones
                if (notifications.length === 0) {
                    notifications.push({
                        id: 'system-1',
                        type: 'system',
                        message: 'CallCatcher system is active and ready',
                        time: '1 hour ago',
                        read: true
                    });
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
                notifications = [{
                    id: 'error-1',
                    type: 'system',
                    message: 'CallCatcher system is active',
                    time: 'Now',
                    read: true
                }];
            }

            renderNotifications(notifications);
            updateNotificationBadge(notifications);
        }

        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
            return `${Math.floor(diffInSeconds / 86400)} days ago`;
        }

        async function updatePastAppointments() {
            try {
                const now = new Date();
                const pastAppointments = appointments.filter(apt => {
                    const aptEndTime = new Date(apt.end_time);
                    return aptEndTime < now && apt.status === 'scheduled';
                });

                console.log(`Found ${pastAppointments.length} past appointments to update`);

                // Update past appointments to completed status
                for (const apt of pastAppointments) {
                    try {
                        const token = localStorage.getItem('token');
                        const response = await fetch(`/api/businesses/${businessData.id}/appointments/${apt.id}`, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                status: 'completed'
                            })
                        });

                        if (response.ok) {
                            // Update local data
                            apt.status = 'completed';
                            console.log(`Updated appointment ${apt.id} to completed`);
                        }
                    } catch (error) {
                        console.error(`Error updating appointment ${apt.id}:`, error);
                    }
                }
            } catch (error) {
                console.error('Error updating past appointments:', error);
            }
        }

        function renderNotifications(notifications) {
            const container = document.getElementById('notifications-list');
            
            if (notifications.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">No new notifications</div>';
                return;
            }

            container.innerHTML = notifications.map(notif => {
                const bgColor = notif.type === 'new_booking' ? 'bg-blue-50 border-l-blue-500' : 'bg-orange-50 border-l-orange-500';
                return `
                    <div class="p-3 border-l-4 ${bgColor} ${notif.read ? 'opacity-60' : ''}">
                        <div class="text-sm font-medium text-gray-900">${notif.message}</div>
                        <div class="text-xs text-gray-500 mt-1">${notif.time}</div>
                    </div>
                `;
            }).join('');
        }

        function updateNotificationBadge(notifications) {
            const badge = document.getElementById('notification-badge');
            const unreadCount = notifications.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // Action functions
        function testCall() {
            const phoneNumber = document.getElementById('phone-number').textContent;
            alert(`üìû Test your AI system:\n\nCall: ${phoneNumber}\n\nSay: "I need a plumber for my kitchen sink"\n\nThe AI will offer available appointment times and book the appointment automatically!`);
        }

        async function testSMS() {
            try {
                const token = localStorage.getItem('token');
                const testPhone = prompt('Enter phone number to test SMS (or leave blank to use your number):');
                
                if (testPhone === null) return; // Cancelled
                
                const response = await fetch(`/api/test-sms/${businessData.id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        testMessage: 'TEST: CallCatcher SMS notifications are working! üì±‚úÖ',
                        testPhone: testPhone || undefined
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert(`‚úÖ SMS Test Successful!\n\nSMS ID: ${result.smsId}\nFrom: ${result.from}\nTo: ${result.to}\n\nCheck your phone for the test message!`);
                } else {
                    alert(`‚ùå SMS Test Failed:\n\n${result.details || result.error}\n\nCode: ${result.code || 'Unknown'}`);
                    console.error('SMS test error:', result);
                }
            } catch (error) {
                console.error('SMS test error:', error);
                alert(`‚ùå SMS Test Error:\n\n${error.message}`);
            }
        }

        function refreshAppointments() {
            loadDashboardData();
        }

        function showAnalytics() {
            alert('üìä Analytics feature coming soon!\n\nThis will show detailed business metrics, revenue trends, and performance insights.');
        }

        function viewAnalytics() {
            showAnalytics();
        }

        // Service Management Functions
        function showServiceManager() {
            document.getElementById('service-manager-modal').classList.remove('hidden');
            loadServices();
        }

        function hideServiceManager() {
            document.getElementById('service-manager-modal').classList.add('hidden');
        }

        function addNewService() {
            document.getElementById('service-edit-title').textContent = 'Add New Service';
            document.getElementById('service-form').reset();
            document.getElementById('service-id').value = '';
            document.getElementById('service-active').checked = true;
            document.getElementById('service-edit-modal').classList.remove('hidden');
        }

        function editService(serviceId) {
            // Load service data and populate form
            const token = localStorage.getItem('token');
            fetch(`/api/businesses/${businessData.id}/service-types`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(response => response.json())
            .then(services => {
                const service = services.find(s => s.id === serviceId);
                if (service) {
                    document.getElementById('service-edit-title').textContent = 'Edit Service';
                    document.getElementById('service-id').value = service.id;
                    document.getElementById('service-name').value = service.name;
                    document.getElementById('service-description').value = service.description || '';
                    document.getElementById('service-rate').value = service.base_rate;
                    document.getElementById('service-duration').value = service.duration_minutes;
                    document.getElementById('service-multiplier').value = service.emergency_multiplier;
                    document.getElementById('service-buffer').value = service.travel_buffer_minutes;
                    document.getElementById('service-emergency').checked = service.is_emergency;
                    document.getElementById('service-active').checked = service.is_active;
                    document.getElementById('service-edit-modal').classList.remove('hidden');
                }
            });
        }

        function hideServiceEdit() {
            document.getElementById('service-edit-modal').classList.add('hidden');
        }

        async function loadServices() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/businesses/${businessData.id}/service-types`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const services = await response.json();
                    renderServices(services);
                }
            } catch (error) {
                console.error('Error loading services:', error);
            }
        }

        function renderServices(services) {
            const container = document.getElementById('services-list');
            
            if (services.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">No services configured yet</div>';
                return;
            }

            container.innerHTML = services.map(service => `
                <div class="border border-gray-200 rounded-lg p-4 ${!service.is_active ? 'opacity-60' : ''}">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <h4 class="font-semibold text-gray-900">${service.name}</h4>
                            ${service.is_emergency ? '<span class="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full">Emergency</span>' : ''}
                            ${!service.is_active ? '<span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded-full">Inactive</span>' : ''}
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-lg font-bold text-green-600">$${service.base_rate}</span>
                            <button onclick="editService('${service.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                            <button onclick="deleteService('${service.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-3">${service.description || 'No description'}</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-xs text-gray-500">
                        <div><strong>Duration:</strong> ${service.duration_minutes} min</div>
                        <div><strong>Emergency Rate:</strong> ${service.emergency_multiplier}x</div>
                        <div><strong>Travel Buffer:</strong> ${service.travel_buffer_minutes} min</div>
                        <div><strong>Status:</strong> ${service.is_active ? 'Active' : 'Inactive'}</div>
                    </div>
                </div>
            `).join('');
        }

        async function deleteService(serviceId) {
            if (!confirm('Are you sure you want to delete this service?')) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/businesses/${businessData.id}/service-types/${serviceId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    loadServices(); // Reload the list
                } else {
                    alert('Error deleting service');
                }
            } catch (error) {
                console.error('Error deleting service:', error);
                alert('Error deleting service');
            }
        }

        // Handle service form submission
        document.getElementById('service-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const serviceData = {
                name: document.getElementById('service-name').value,
                description: document.getElementById('service-description').value,
                base_rate: parseFloat(document.getElementById('service-rate').value),
                duration_minutes: parseInt(document.getElementById('service-duration').value),
                emergency_multiplier: parseFloat(document.getElementById('service-multiplier').value),
                travel_buffer_minutes: parseInt(document.getElementById('service-buffer').value),
                is_emergency: document.getElementById('service-emergency').checked,
                is_active: document.getElementById('service-active').checked
            };
            
            try {
                const token = localStorage.getItem('token');
                const serviceId = document.getElementById('service-id').value;
                const method = serviceId ? 'PUT' : 'POST';
                const url = serviceId ? 
                    `/api/businesses/${businessData.id}/service-types/${serviceId}` :
                    `/api/businesses/${businessData.id}/service-types`;
                
                console.log('Creating service:', serviceData);
                console.log('URL:', url);
                console.log('Token exists:', !!token);
                console.log('Business ID:', businessData.id);
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(serviceData)
                });
                
                if (response.ok) {
                    hideServiceEdit();
                    loadServices();
                    alert('Service saved successfully!');
                } else {
                    const errorData = await response.json();
                    console.error('Server error:', errorData);
                    alert('Error saving service: ' + (errorData.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving service:', error);
                alert('Error saving service: ' + error.message);
            }
        });

        function manageServices() {
            showServiceManager();
        }

        function customizeAI() {
            alert('ü§ñ AI Customization coming soon!\n\nThis will let you adjust your AI personality, responses, and behavior.');
        }

        function viewBilling() {
            alert('üí≥ Billing & Usage coming soon!\n\nThis will show your subscription details, usage metrics, and payment history.');
        }

        function showSettings() {
            window.location.href = '/settings';
        }

        // Team Management Functions
        function manageTeam() {
            document.getElementById('team-manager-modal').classList.remove('hidden');
            loadTeamMembers();
        }

        function hideTeamManager() {
            document.getElementById('team-manager-modal').classList.add('hidden');
        }

        async function loadTeamMembers() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/businesses/${businessData.id}/team-members`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const teamMembers = await response.json();
                    renderTeamMembers(teamMembers);
                } else {
                    console.error('Failed to load team members');
                }
            } catch (error) {
                console.error('Error loading team members:', error);
            }
        }

        function renderTeamMembers(teamMembers) {
            const container = document.getElementById('team-members-list');
            
            if (teamMembers.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">No team members added yet</div>';
                return;
            }

            container.innerHTML = teamMembers.map(member => {
                const roleColor = member.role === 'owner' ? 'bg-blue-100 text-blue-700' : 
                                member.role === 'manager' ? 'bg-green-100 text-green-700' : 
                                'bg-gray-100 text-gray-700';
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 ${!member.is_active ? 'opacity-60' : ''}">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center text-lg">
                                    üë§
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-900">${member.name}</h4>
                                    <p class="text-sm text-gray-600">${member.email || 'No email'}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${roleColor}">
                                    ${member.role}
                                </span>
                                <button onclick="editTeamMember('${member.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                <button onclick="deleteTeamMember('${member.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                            <div><strong>Phone:</strong> ${member.mobile_phone}</div>
                            <div><strong>Notifications:</strong> ${member.can_receive_notifications ? 'Enabled' : 'Disabled'}</div>
                            <div><strong>Specialties:</strong> ${member.specialties?.join(', ') || 'None'}</div>
                            <div><strong>Status:</strong> ${member.is_active ? 'Active' : 'Inactive'}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addTeamMember() {
            document.getElementById('team-edit-title').textContent = 'Add Team Member';
            document.getElementById('team-form').reset();
            document.getElementById('team-member-id').value = '';
            document.getElementById('team-edit-modal').classList.remove('hidden');
        }

        function hideTeamEdit() {
            document.getElementById('team-edit-modal').classList.add('hidden');
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('business');
            localStorage.removeItem('onboarding_complete');
            window.location.href = '/';
        }

        // Utility functions
        function formatPhoneNumber(phoneNumber) {
            const cleaned = phoneNumber.replace(/\D/g, '');
            const match = cleaned.match(/^(\d{3})(\d{3})(\d{4})$/);
            if (match) {
                return `(${match[1]}) ${match[2]}-${match[3]}`;
            }
            return phoneNumber;
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Close notifications when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('notifications-dropdown');
            if (!dropdown.contains(e.target) && !e.target.closest('[onclick="toggleNotifications()"]')) {
                dropdown.classList.add('hidden');
            }
        });
    </script>
</body>
</html>