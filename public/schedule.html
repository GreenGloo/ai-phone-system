<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Management - CallCatcher</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .appointment-card {
            transition: all 0.3s ease;
        }
        
        .appointment-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .appointment-card.current {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }
        
        .appointment-card.completed {
            background-color: #f0fdf4;
            border-color: #22c55e;
        }
        
        .appointment-card.delayed {
            background-color: #fef2f2;
            border-color: #ef4444;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-scheduled { background-color: #3b82f6; }
        .status-en-route { background-color: #f59e0b; }
        .status-arrived { background-color: #10b981; }
        .status-completed { background-color: #6b7280; }
        .status-delayed { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto p-4">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Schedule Management</h1>
                    <p class="text-gray-600">Manage your daily schedule and communicate with customers</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-sm text-gray-600">
                        <span class="font-medium">Current Time:</span>
                        <span id="current-time" class="font-mono">--:--</span>
                    </div>
                    <button onclick="refreshSchedule()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        Refresh
                    </button>
                    <a href="/calendar" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700">
                        Calendar View
                    </a>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Schedule Timeline -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-gray-900">Today's Schedule</h2>
                        <div class="flex gap-2">
                            <button onclick="markCurrentCompleted()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm">
                                ‚úì Complete Current
                            </button>
                            <button onclick="showRunningLateModal()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 text-sm">
                                üïê Running Late
                            </button>
                        </div>
                    </div>
                    
                    <div id="schedule-timeline" class="space-y-4">
                        <!-- Schedule items will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Quick Actions & Status -->
            <div class="space-y-6">
                <!-- Current Status -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Current Status</h3>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Next Appointment:</span>
                            <span id="next-appointment" class="font-medium">Loading...</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Time Until Next:</span>
                            <span id="time-until-next" class="font-medium">--</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Schedule Status:</span>
                            <span id="schedule-status" class="font-medium text-green-600">On Time</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Quick Actions</h3>
                    <div class="space-y-3">
                        <button onclick="sendArrivedMessage()" class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 text-sm">
                            üìç I've Arrived
                        </button>
                        <button onclick="sendEnRouteMessage()" class="w-full bg-yellow-600 text-white py-2 px-4 rounded hover:bg-yellow-700 text-sm">
                            üöó En Route (30 min)
                        </button>
                        <button onclick="sendCustomMessage()" class="w-full bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700 text-sm">
                            üí¨ Custom Message
                        </button>
                        <button onclick="showEarlyArrivalModal()" class="w-full bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 text-sm">
                            ‚è∞ Ask About Early Arrival
                        </button>
                    </div>
                </div>

                <!-- Communication Log -->
                <div class="bg-white rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Recent Messages</h3>
                    <div id="communication-log" class="space-y-2 max-h-64 overflow-y-auto">
                        <div class="text-center py-4 text-gray-500 text-sm">
                            No recent messages
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Running Late Modal -->
    <div id="running-late-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Notify Customers - Running Late</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">How many minutes late?</label>
                    <select id="late-minutes" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="15">15 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="45">45 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="90">1.5 hours</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Reason (optional)</label>
                    <select id="late-reason" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">Select reason...</option>
                        <option value="Previous job taking longer">Previous job taking longer</option>
                        <option value="Traffic delays">Traffic delays</option>
                        <option value="Equipment issue">Equipment issue</option>
                        <option value="Emergency call">Emergency call came up</option>
                        <option value="Supply run needed">Need to pick up supplies</option>
                    </select>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <h4 class="font-medium mb-2">Message Preview:</h4>
                    <p id="late-message-preview" class="text-sm text-gray-600">
                        Hi! This is Smith Plumbing. I'm running about 30 minutes behind schedule today. Your appointment window is now 2:30-3:00 PM. Thanks for your patience!
                    </p>
                </div>
                <div class="flex gap-3">
                    <button onclick="sendRunningLateMessage()" class="flex-1 bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">
                        Send to All Customers
                    </button>
                    <button onclick="closeRunningLateModal()" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Early Arrival Modal -->
    <div id="early-arrival-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Ask About Early Arrival</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Customer:</label>
                    <select id="early-customer" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">Select next customer...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">How much earlier?</label>
                    <select id="early-minutes" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="15">15 minutes early</option>
                        <option value="30">30 minutes early</option>
                        <option value="45">45 minutes early</option>
                        <option value="60">1 hour early</option>
                    </select>
                </div>
                <div class="bg-gray-50 p-3 rounded">
                    <h4 class="font-medium mb-2">Message Preview:</h4>
                    <p id="early-message-preview" class="text-sm text-gray-600">
                        Hi John! This is Smith Plumbing. I'm ahead of schedule and could arrive 30 minutes early (around 1:30 PM) if that works for you. Reply YES if that's okay, or I'll stick to the original 2:00 PM window. Thanks!
                    </p>
                </div>
                <div class="flex gap-3">
                    <button onclick="sendEarlyArrivalMessage()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">
                        Send Message
                    </button>
                    <button onclick="closeEarlyArrivalModal()" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Message Modal -->
    <div id="custom-message-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Send Custom Message</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Recipients:</label>
                    <select id="custom-recipients" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="all">All today's customers</option>
                        <option value="remaining">Remaining customers only</option>
                        <option value="next">Next customer only</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Message:</label>
                    <textarea id="custom-message-text" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Type your message..."></textarea>
                    <div class="text-xs text-gray-500 mt-1">160 characters max for SMS</div>
                </div>
                <div class="flex gap-3">
                    <button onclick="sendCustomMessageToCustomers()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                        Send Message
                    </button>
                    <button onclick="closeCustomMessageModal()" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let todayAppointments = [];
        let currentAppointmentIndex = 0;
        let communicationLog = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshSchedule();
            updateCurrentTime();
            setInterval(updateCurrentTime, 60000); // Update every minute
            setInterval(refreshSchedule, 30000); // Refresh every 30 seconds
        });

        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        // Refresh schedule
        async function refreshSchedule() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`/api/appointments?date=${today}`);
                todayAppointments = await response.json();
                
                // Sort by start time
                todayAppointments.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));
                
                renderScheduleTimeline();
                updateStatusPanel();
                updateEarlyArrivalOptions();
                
            } catch (error) {
                console.error('Error refreshing schedule:', error);
            }
        }

        // Render schedule timeline
        function renderScheduleTimeline() {
            const container = document.getElementById('schedule-timeline');
            
            if (todayAppointments.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500">No appointments scheduled for today</div>';
                return;
            }

            container.innerHTML = todayAppointments.map((apt, index) => {
                const startTime = new Date(apt.startTime);
                const endTime = new Date(apt.endTime);
                const now = new Date();
                
                // Calculate time window (¬±30 minutes)
                const windowStart = new Date(startTime.getTime() - 30 * 60 * 1000);
                const windowEnd = new Date(startTime.getTime() + 30 * 60 * 1000);
                
                const timeWindow = `${windowStart.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true})} - ${windowEnd.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true})}`;
                
                // Determine status
                let status = apt.status || 'scheduled';
                let statusClass = 'status-scheduled';
                let cardClass = '';
                
                if (apt.completed) {
                    status = 'completed';
                    statusClass = 'status-completed';
                    cardClass = 'completed';
                } else if (now > endTime) {
                    status = 'delayed';
                    statusClass = 'status-delayed';
                    cardClass = 'delayed';
                } else if (now >= windowStart && now <= windowEnd) {
                    status = 'current';
                    statusClass = 'status-en-route';
                    cardClass = 'current';
                    currentAppointmentIndex = index;
                }

                return `
                    <div class="appointment-card border-2 rounded-lg p-4 ${cardClass}" data-appointment-id="${apt.id}">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="status-dot ${statusClass}"></span>
                                    <span class="font-bold text-lg">${timeWindow}</span>
                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${apt.service === 'emergency' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">
                                        ${apt.service}
                                    </span>
                                </div>
                                <div class="text-lg font-medium text-gray-900 mb-1">
                                    üë§ ${apt.customerName}
                                </div>
                                <div class="text-sm text-gray-600 mb-2">
                                    üìû ${apt.customerPhone}
                                </div>
                                ${apt.address ? `<div class="text-sm text-gray-600 mb-2">üìç ${apt.address}</div>` : ''}
                                <div class="text-sm text-gray-800 mb-2">
                                    <strong>Issue:</strong> ${apt.issue || 'Not specified'}
                                </div>
                                <div class="flex items-center gap-4 text-xs text-gray-500">
                                    <span>üí∞ $${apt.estimatedRevenue}</span>
                                    <span>‚è±Ô∏è ${apt.duration} min</span>
                                    <span>üì± ${apt.bookedVia}</span>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2 ml-4">
                                <button onclick="callCustomer('${apt.customerPhone}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700">
                                    üìû Call
                                </button>
                                <button onclick="sendDirectMessage('${apt.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                    üí¨ Text
                                </button>
                                ${!apt.completed ? `<button onclick="markCompleted('${apt.id}')" class="bg-gray-600 text-white px-3 py-1 rounded text-xs hover:bg-gray-700">‚úì Done</button>` : ''}
                            </div>
                        </div>
                        
                        ${apt.communicationHistory ? `
                            <div class="border-t pt-2 mt-2">
                                <div class="text-xs text-gray-500">Recent: ${apt.communicationHistory}</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Update status panel
        function updateStatusPanel() {
            if (todayAppointments.length === 0) {
                document.getElementById('next-appointment').textContent = 'None today';
                document.getElementById('time-until-next').textContent = '--';
                document.getElementById('schedule-status').textContent = 'No appointments';
                return;
            }

            const now = new Date();
            const nextApt = todayAppointments.find(apt => !apt.completed && new Date(apt.startTime) > now);
            
            if (nextApt) {
                const nextTime = new Date(nextApt.startTime);
                const timeUntil = Math.ceil((nextTime - now) / (1000 * 60)); // minutes
                
                document.getElementById('next-appointment').textContent = nextApt.customerName;
                document.getElementById('time-until-next').textContent = timeUntil > 0 ? `${timeUntil} min` : 'Now';
                
                // Determine schedule status
                if (timeUntil < -30) {
                    document.getElementById('schedule-status').textContent = 'Running Late';
                    document.getElementById('schedule-status').className = 'font-medium text-red-600';
                } else if (timeUntil > 60) {
                    document.getElementById('schedule-status').textContent = 'Ahead of Schedule';
                    document.getElementById('schedule-status').className = 'font-medium text-green-600';
                } else {
                    document.getElementById('schedule-status').textContent = 'On Time';
                    document.getElementById('schedule-status').className = 'font-medium text-green-600';
                }
            } else {
                document.getElementById('next-appointment').textContent = 'All complete';
                document.getElementById('time-until-next').textContent = '--';
                document.getElementById('schedule-status').textContent = 'Day Complete';
                document.getElementById('schedule-status').className = 'font-medium text-green-600';
            }
        }

        // Show running late modal
        function showRunningLateModal() {
            document.getElementById('running-late-modal').classList.remove('hidden');
            updateLateMessagePreview();
        }

        function closeRunningLateModal() {
            document.getElementById('running-late-modal').classList.add('hidden');
        }

        // Update late message preview
        function updateLateMessagePreview() {
            const minutes = document.getElementById('late-minutes').value;
            const reason = document.getElementById('late-reason').value;
            
            let message = `Hi! This is Smith Plumbing. I'm running about ${minutes} minutes behind schedule today.`;
            
            if (reason) {
                message += ` ${reason}.`;
            }
            
            message += ` Your appointment window has been adjusted accordingly. Thanks for your patience!`;
            
            document.getElementById('late-message-preview').textContent = message;
        }

        // Send running late message
        async function sendRunningLateMessage() {
            const minutes = parseInt(document.getElementById('late-minutes').value);
            const reason = document.getElementById('late-reason').value;
            
            try {
                const response = await fetch('/api/send-running-late', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ delayMinutes: minutes, reason })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Message sent to ${result.customerCount} customers`);
                    closeRunningLateModal();
                    refreshSchedule();
                } else {
                    alert('Error sending messages: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error sending messages');
            }
        }

        // Show early arrival modal
        function showEarlyArrivalModal() {
            updateEarlyArrivalOptions();
            document.getElementById('early-arrival-modal').classList.remove('hidden');
            updateEarlyMessagePreview();
        }

        function closeEarlyArrivalModal() {
            document.getElementById('early-arrival-modal').classList.add('hidden');
        }

        // Update early arrival customer options
        function updateEarlyArrivalOptions() {
            const select = document.getElementById('early-customer');
            const now = new Date();
            const upcomingAppointments = todayAppointments.filter(apt => 
                !apt.completed && new Date(apt.startTime) > now
            ).slice(0, 3); // Next 3 appointments
            
            select.innerHTML = '<option value="">Select next customer...</option>';
            
            upcomingAppointments.forEach(apt => {
                const time = new Date(apt.startTime).toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
                select.innerHTML += `<option value="${apt.id}">${apt.customerName} (${time})</option>`;
            });
        }

        // Update early message preview
        function updateEarlyMessagePreview() {
            const customerId = document.getElementById('early-customer').value;
            const minutes = document.getElementById('early-minutes').value;
            
            if (!customerId) {
                document.getElementById('early-message-preview').textContent = 'Please select a customer first.';
                return;
            }
            
            const customer = todayAppointments.find(apt => apt.id === customerId);
            const originalTime = new Date(customer.startTime);
            const earlyTime = new Date(originalTime.getTime() - minutes * 60 * 1000);
            
            const message = `Hi ${customer.customerName}! This is Smith Plumbing. I'm ahead of schedule and could arrive ${minutes} minutes early (around ${earlyTime.toLocaleTimeString('en-US', {hour: 'numeric', minute: '2-digit', hour12: true})}) if that works for you. Reply YES if that's okay, or I'll stick to the original time window. Thanks!`;
            
            document.getElementById('early-message-preview').textContent = message;
        }

        // Send early arrival message
        async function sendEarlyArrivalMessage() {
            const customerId = document.getElementById('early-customer').value;
            const minutes = parseInt(document.getElementById('early-minutes').value);
            
            if (!customerId) {
                alert('Please select a customer');
                return;
            }
            
            try {
                const response = await fetch('/api/send-early-arrival', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appointmentId: customerId, earlyMinutes: minutes })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Early arrival message sent!');
                    closeEarlyArrivalModal();
                } else {
                    alert('Error sending message: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error sending message');
            }
        }

        // Send standard messages
        async function sendArrivedMessage() {
            await sendQuickMessage('arrived');
        }

        async function sendEnRouteMessage() {
            await sendQuickMessage('enroute');
        }

        async function sendQuickMessage(type) {
            const nextApt = todayAppointments.find(apt => !apt.completed);
            if (!nextApt) {
                alert('No upcoming appointments');
                return;
            }
            
            try {
                const response = await fetch('/api/send-quick-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appointmentId: nextApt.id, messageType: type })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Message sent!');
                } else {
                    alert('Error sending message: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error sending message');
            }
        }

        // Show custom message modal
        function sendCustomMessage() {
            document.getElementById('custom-message-modal').classList.remove('hidden');
        }

        function closeCustomMessageModal() {
            document.getElementById('custom-message-modal').classList.add('hidden');
        }

        // Send custom message to customers
        async function sendCustomMessageToCustomers() {
            const recipients = document.getElementById('custom-recipients').value;
            const message = document.getElementById('custom-message-text').value;
            
            if (!message.trim()) {
                alert('Please enter a message');
                return;
            }
            
            try {
                const response = await fetch('/api/send-custom-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipients, message })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Message sent to ${result.customerCount} customers`);
                    closeCustomMessageModal();
                    document.getElementById('custom-message-text').value = '';
                } else {
                    alert('Error sending message: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error sending message');
            }
        }

        // Mark appointment as completed
        async function markCompleted(appointmentId) {
            try {
                const response = await fetch('/api/complete-appointment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appointmentId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    refreshSchedule();
                } else {
                    alert('Error marking complete: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error marking complete');
            }
        }

        // Mark current appointment as completed
        function markCurrentCompleted() {
            const currentApt = todayAppointments[currentAppointmentIndex];
            if (currentApt && !currentApt.completed) {
                markCompleted(currentApt.id);
            }
        }

        // Call customer
        function callCustomer(phoneNumber) {
            window.open(`tel:${phoneNumber}`, '_self');
        }

        // Send direct message to specific customer
        function sendDirectMessage(appointmentId) {
            const message = prompt('Enter message to send:');
            if (message) {
                sendCustomMessageToSpecificCustomer(appointmentId, message);
            }
        }

        async function sendCustomMessageToSpecificCustomer(appointmentId, message) {
            try {
                const response = await fetch('/api/send-direct-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appointmentId, message })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Message sent!');
                } else {
                    alert('Error sending message: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error sending message');
            }
        }

        // Event listeners for modal updates
        document.getElementById('late-minutes').addEventListener('change', updateLateMessagePreview);
        document.getElementById('late-reason').addEventListener('change', updateLateMessagePreview);
        document.getElementById('early-customer').addEventListener('change', updateEarlyMessagePreview);
        document.getElementById('early-minutes').addEventListener('change', updateEarlyMessagePreview);
    </script>
</body>
</html>
